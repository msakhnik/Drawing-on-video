<!DOCTYPE html>

<html>
    <head>
        <title>Annotation</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />
        <!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
        <script src="js/canvas.js" type="text/javascript"></script>
        <script src="js/jquery-1.7.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="js/jquery.colorPicker.js"></script>        

        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/colorPicker.css">        
    </head>

    <body>
        
            <div id="video_wrap">
                <canvas id='canvas'></canvas>
                <video id="draw_window"></video>

                <script type="text/javascript">

                    var videoWidth = 420;
                    var videoHeight = 320;

                    var canvas = $('#canvas').get(0);
                    var video = $('#draw_window').get(0);
                    var ctx = canvas.getContext('2d');
                    

                    //main associative array, key - current second,  value - data image-data
                    //if we want put last moment recording - point[n] = 0

                    var point = new Array();

                    function startRecord() {
                         point[Math.ceil(video.currentTime)] = ctx.getImageData(0, 0, canvas.width, canvas.height);
                         $('#start_record').attr('disabled', 'disabled');
                         $('#stop_record').removeAttr('disabled');
                    }

                    function stopRecord() {

                         $('#start_record').removeAttr('disabled');
                         $('#stop_record').attr('disabled', 'disabled');
                    }

                    function clearAnnotation() {
                        ctx.clearRect (0 , 0 , canvas.width ,canvas.height);
                    }

                     function listen() {

                         var key = Math.ceil(video.currentTime);

                         if (video.paused || video.ended) {
                             return false
                         }

                         console.log("Element: ", key, point[key]);

                         if (point[key]) {
                             ctx.putImageData(point[key], 0, 0);
                         }

                         setTimeout(listen, 1000);

                        return true;
                    }

                    video.onplay = function() {
                        var key = Math.ceil(video.currentTime);
                        point[key] = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        console.log("Element", key);
                        listen();
                        video.paused = true;
                    }

                    video.onended = function() {
                        clearAnnotation();
                    }

                    function draw_pencil() {
                        var canvas_pencil = $('#pencil').get(0);
                        canvas_pencil.width = 16;
                        canvas_pencil.height = 16;
                        var context = canvas_pencil.getContext('2d');
                        //becose div has size 16*16
                        var centerX = 8;
                        var centerY = 8;
                        var radius = Math.ceil($('#size1 option:selected').val() / 2);

                        context.beginPath();
                        context.clearRect(0, 0, 16, 16);
                        context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);

                        context.fillStyle = $('#color1').attr('value');
                        context.fill();
                    }

                    $(document).ready(function(){

                        $('#video_wrap').css('width', videoWidth);
                        $('#video_wrap').css('height', videoHeight);

                        $('#draw_window').attr('width', videoWidth);
                        $('#draw_window').attr('height', videoHeight);
                    
                        var video = $('#draw_window').get(0);
                            video.src = 'mousepointer.ogv';
                            video.id = 'draw_window';
                            video.controls = true;


                        canvas.width = videoWidth;
                        //left space for manage panel
                        canvas.height = videoHeight  - 27;

                        Canva.init('canvas', canvas.width, canvas.height);
                        Canva.selectedColor = $('#color1').attr('value');
                        Canva.selectedWidth = $('#size1 option:selected').val();
                        Canva.tool = Pencil;
                        $('#erase1').css('opacity', '1')
                        $('#color1').colorPicker();
                        draw_pencil();

                        
                        $('#color1').change(function(){
                            Canva.selectedColor = $(this).attr('value');
                            draw_pencil();
                        })

                        $('#size1').change(function(){
                            Canva.selectedWidth = $(this).attr('value');
                            draw_pencil();
                        })

                        $('#erase1').click(function(){
                            if ($(this).css('opacity') == 1) {
                                Canva.tool = Erase;
                                $(this).css('opacity', '0.5');
                            } else {
                                Canva.tool = Pencil;
                                $(this).css('opacity', '1');
                            }

                        })

                    })

                    $('#clear').click(function(){
                            clearAnnotation();
                    })

                    function defaultSettings() {
                        canvas.width = videoWidth;
                        canvas.height = videoHeight  - 27;

                        Canva.init('canvas', canvas.width, canvas.height);
                        point.length = 0;
                    }
                    
                </script>
            </div>
            <div id ="manage_wrap">
                <form name="save_image" action="POST">
                    <fieldset>
                        <legend>Setting:</legend>

                            <div id="picker"><label for="color1">Color </label> <input id="color1" type="text" name="color1" value="#333399" /> </div>

                            <div class="clear"></div>
                            <div id="size">

                                <label for="size1" style="float:left; margin-right: 10px; margin-top:4px;">Size </label>
                                <div>
                                    <div id="draw_pencil" style="margin-top: 4px;">
                                        <canvas id="pencil"></canvas>
                                    </div>
                                    <select id="size1" >
                                        <option selected value="1">1px</option>
                                        <option value="2">2px</option>
                                        <option value="3">3px</option>
                                        <option value="4">4px</option>
                                        <option value="5">5px</option>
                                        <option value="6">6px</option>
                                        <option value="7">7px</option>
                                        <option value="8">8px</option>
                                        <option value="9">9px</option>
                                        <option value="10">10px</option>
                                        <option value="11">11px</option>
                                        <option value="12">12px</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="clear"></div>
                            <div id="erase">

                                <span>Erase</span>
                                <a href="#" id="erase1"></a>

                            </div>

                            <div class="clear"></div>
                            <button id="clear" name ="clear" type="button" onClick="clearAnnotation()">Clear</button>
                            <button id="default" name ="default" type="button" onClick="defaultSettings()">Default</button>
                      </fieldset>
                </form>
            </div>        
    </body>

</html>

