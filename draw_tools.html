<!DOCTYPE html>

<html>
    <head>
        <title>Annotation</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />
        <script src="js/canvas.js" type="text/javascript"></script>
        <script src="js/jquery-1.7.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="js/jquery.colorPicker.js"></script>        

        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/colorPicker.css">        
    </head>

    <body>
        
            <div id="video_wrap">
                <canvas id='canvas'></canvas>
                <video id="draw_window"></video>

                <script type="text/javascript">


                    var canvas = $('#canvas').get(0);
                    var video = $('#draw_window').get(0);
                    var ctx = canvas.getContext('2d');
                    

                    //main associative array, key - current second,  value - data image-data

                    var point = new Array();

                    function clearAnnotation() {
                        ctx.clearRect (0 , 0 , canvas.width ,canvas.height);
                    }

                     function listen() {

                         var key = Math.ceil(video.currentTime);

                         if (video.paused || video.ended) {
                             $('#clear').removeAttr('disabled');

                             return false
                         }

                         if (point[key]) {
                             ctx.putImageData(point[key], 0, 0);
                         }

                         setTimeout(listen, 1000);

                        return true;
                    }

                    function draw_pencil() {
                        var canvas_pencil = $('#pencil').get(0);
                        canvas_pencil.width = 16;
                        canvas_pencil.height = 16;
                        var context = canvas_pencil.getContext('2d');
                        
                        var centerX = 8;
                        var centerY = 8;
                        var radius = Math.ceil($('#size1 option:selected').val() / 2);

                        context.beginPath();
                        context.clearRect(0, 0, 16, 16);
                        context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);

                        context.fillStyle = $('#color1').attr('value');
                        context.fill();
                    }

                    $(document).ready(function(){
                    
                        var video = $('#draw_window').get(0);
                            video.src = 'CodemindersOffice.m4v';
                            video.id = 'draw_window';
                            video.controls = true;

                        $("#draw_window").bind('play', function(){

                            $('#clear').attr('disabled', 'disabled');

                            var key = Math.ceil(video.currentTime);
                            point[key] = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            listen();
                        })

                        $("#draw_window").bind('ended', function(){
                            clearAnnotation();
                            video.play();
                            video.pause();
                        })

                        
                        $('#color1').colorPicker();
                        defaultSettings();

                        $('#color1').change(function(){
                            Canva.selectedColor = $(this).attr('value');
                            draw_pencil();
                        })

                        $('#size1').change(function(){
                            Canva.selectedWidth = $(this).attr('value');
                            draw_pencil();
                        })

                        $('#erase1').click(function(){
                            if ($(this).css('opacity') == 1) {
                                Canva.tool = Erase;
                                $(this).css('opacity', '0.5');
                            } else {
                                Canva.tool = Pencil;
                                $(this).css('opacity', '1');
                            }

                        })

                        $('ul li a').click(function(){
                            point.length = 0;

                            video.src = $(this).html();
                            video.load();
                        })

                        $(video).bind("loadedmetadata", function () {

                            canvas.width = this.videoWidth;
                            canvas.height =  this.videoHeight - (0.12 * this.videoHeight);

                        });

                    })

                    $('#clear').click(function(){
                            clearAnnotation();
                    })

                    function defaultSettings() {

                        Canva.init('canvas', canvas.width, canvas.height, 'draw_window');
                        point.length = 0;

                        $('#color1').val('#000080');
                        $('#color1').change();
                        Canva.selectedColor = $('#color1').attr('value');

                        $('#size1 [value="6"]').attr('selected', 'selected');
                        Canva.selectedWidth = $('#size1 option:selected').val();
                        
                        Canva.tool = Pencil;
                        $('#erase1').css('opacity', '1')
                        
                        draw_pencil();

                    }
                    
                </script>
            </div>
            <div id ="manage_wrap">
                <form name="save_image" action="POST">
                    <fieldset>
                        <legend>Settings:</legend>

                            <div id="picker"><label for="color1">Color </label> <input id="color1" type="text" name="color1" value="#000080" /> </div>

                            <div class="clear"></div>
                            <div id="size">

                                <label for="size1" style="float:left; margin-right: 10px; margin-top:4px;">Size </label>
                                <div>
                                    <div id="draw_pencil" style="margin-top: 4px;">
                                        <canvas id="pencil"></canvas>
                                    </div>
                                    <select id="size1" >
                                        <option selected value="1">1px</option>
                                        <option value="2">2px</option>
                                        <option value="3">3px</option>
                                        <option value="4">4px</option>
                                        <option value="5">5px</option>
                                        <option value="6">6px</option>
                                        <option value="7">7px</option>
                                        <option value="8">8px</option>
                                        <option value="9">9px</option>
                                        <option value="10">10px</option>
                                        <option value="11">11px</option>
                                        <option value="12">12px</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="clear"></div>
                            <div id="erase">

                                <span>Erase</span>
                                <a href="#" id="erase1"></a>

                            </div>

                            <div class="clear"></div>
                            <button id="clear" name ="clear" type="button" onClick="clearAnnotation()">Clear</button>
                            <button id="default" name ="default" type="button" onClick="defaultSettings()">Default</button>

                      </fieldset>
                </form>

                <fieldset>
                        <legend>Video:</legend>

                        <ul>
                            <li><a href="#" >CodemindersOffice.m4v</a></li>
                            <li><a href="#" >mousepointer.ogv</a></li>
                            <li><a href="#" >bunny.webm</a></li>
                        </ul>
                            
              </fieldset>

            </div>        
    </body>

</html>

